<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Apri Porta - NEASPACE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Anti-cache per GitHub Pages -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <style>
    :root{--bg:#EAF6FF;--fg:#111}
    body{margin:0;background:var(--bg);color:var(--fg);font:600 28px/1.6 system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;text-align:center}
    .wrap{padding:60px 16px}
    .sub{font-size:16px;font-weight:500;opacity:.7;margin-top:6px}
    .err{color:#b00020;font-weight:700}
    .ok{color:#0a6800;font-weight:700}
    .muted{font-size:16px;opacity:.8;margin-top:14px}
    .actions{margin-top:22px}
  </style>
</head>
<body>
  <div class="wrap">
    <div id="msg">‚è≥ Controllo prenotazione.</div>
    <div id="sub" class="sub"></div>
    <div id="hint" class="muted"></div>
    <div id="note" class="muted"></div>
    <div class="actions"><!-- Go back button removed --></div>
  </div>

  <script>
    const API_BASE = "https://one9rueneuve.onrender.com";

    // ===== i18n =====
    const M = {
      it: { waking:"‚è≥ Sto risvegliando il server‚Ä¶", loading:"‚è≥ Controllo prenotazione‚Ä¶",
        missing:"‚ùå Booking ID mancante.", hintMissing:"Aggiungi ?b=NUMERO all‚ÄôURL.",
        okTitle:"üåû La tua avventura a NeaSpace inizia ora: la porta √® aperta.",
        okSub:"Sali al secondo piano (porta destra). Keybox codice 0204.",
        okHintSending:"Invio conferma in corso‚Ä¶", okHintSent:"‚úÖ Conferma inviata.",
        okHintFail:"‚ö†Ô∏è Non riesco a inviare la conferma su Telegram.",
        outside:(s,e)=>`üö™ La porta si apre solo tra ${s} e ${e}.`,
        needHelp:"Se hai bisogno di assistenza contattaci pure.",
        netErr:"‚ö†Ô∏è Errore durante il controllo prenotazione.",
        netExplain:"Il server non ha risposto o il browser ha bloccato la richiesta (CORS/timeout).",
        retryHint:"Riprova tra qualche secondo. Se persiste, verifica CORS su Render.",
        pleaseVideo:"Per favore guardate il video di come aprire e chiudere la porta."
      },
      en: { waking:"‚è≥ Waking the server‚Ä¶", loading:"‚è≥ Checking your booking‚Ä¶",
        missing:"‚ùå Missing booking ID.", hintMissing:"Append ?b=NUMBER to the URL.",
        okTitle:"üåû Your NeaSpace adventure starts now: the door is open.",
        okSub:"Go to the second floor (right door). Keybox code 0204.",
        okHintSending:"Sending confirmation‚Ä¶", okHintSent:"‚úÖ Confirmation sent.",
        okHintFail:"‚ö†Ô∏è Unable to send the Telegram confirmation.",
        outside:(s,e)=>`üö™ The door opens only between ${s} and ${e}.`,
        needHelp:"If you need assistance, just let us know.",
        netErr:"‚ö†Ô∏è Error while checking your booking.",
        netExplain:"The server didn‚Äôt respond or the browser blocked the request (CORS/timeout).",
        retryHint:"Please try again shortly. If it persists, check CORS on Render.",
        pleaseVideo:"Please watch the video on how to open and close the door."
      },
      fr: { waking:"‚è≥ R√©veil du serveur‚Ä¶", loading:"‚è≥ V√©rification de votre r√©servation‚Ä¶",
        missing:"‚ùå ID de r√©servation manquant.", hintMissing:"Ajoutez ?b=NUM√âRO √† l‚ÄôURL.",
        okTitle:"üåû Votre aventure NeaSpace commence maintenant : la porte est ouverte.",
        okSub:"Montez au 2·µâ √©tage (porte √† droite). Bo√Æte √† cl√©s code 0204.",
        okHintSending:"Envoi de la confirmation‚Ä¶", okHintSent:"‚úÖ Confirmation envoy√©e.",
        okHintFail:"‚ö†Ô∏è Impossible d‚Äôenvoyer la confirmation Telegram.",
        outside:(s,e)=>`üö™ La porte s‚Äôouvre uniquement entre le ${s} et le ${e}.`,
        needHelp:"Besoin d‚Äôaide ? Contactez-nous.",
        netErr:"‚ö†Ô∏è Erreur lors de la v√©rification de la r√©servation.",
        netExplain:"Le serveur n‚Äôa pas r√©pondu ou le navigateur a bloqu√© la requ√™te (CORS/timeout).",
        retryHint:"R√©essayez dans quelques instants. Si le probl√®me persiste, v√©rifiez le CORS sur Render.",
        pleaseVideo:"Merci de regarder la vid√©o pour savoir comment ouvrir et fermer la porte."
      },
      es: { waking:"‚è≥ Despertando el servidor‚Ä¶", loading:"‚è≥ Verificando su reserva‚Ä¶",
        missing:"‚ùå Falta el ID de la reserva.", hintMissing:"A√±ada ?b=N√öMERO a la URL.",
        okTitle:"üåû Tu aventura en NeaSpace empieza ahora: la puerta est√° abierta.",
        okSub:"Sube al segundo piso (puerta derecha). C√≥digo de la caja 0204.",
        okHintSending:"Enviando confirmaci√≥n‚Ä¶", okHintSent:"‚úÖ Confirmaci√≥n enviada.",
        okHintFail:"‚ö†Ô∏è No se pudo enviar la confirmaci√≥n por Telegram.",
        outside:(s,e)=>`üö™ La puerta solo se abre entre ${s} y ${e}.`,
        needHelp:"Si necesitas ayuda, av√≠sanos.",
        netErr:"‚ö†Ô∏è Error al verificar la reserva.",
        netExplain:"El servidor no respondi√≥ o el navegador bloque√≥ la solicitud (CORS/timeout).",
        retryHint:"Int√©ntelo de nuevo en unos segundos. Si persiste, revise CORS en Render.",
        pleaseVideo:"Por favor, miren el video de c√≥mo abrir y cerrar la puerta."
      }
    };

    function detectLang(){
      const cand = (navigator.languages && navigator.languages[0]) || navigator.language || "en";
      const code = cand.slice(0,2).toLowerCase();
      return M[code] ? code : "en";
    }

    function fetchWithTimeout(resource, options = {}) {
      const { timeout = 12000 } = options;
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeout);
      return fetch(resource, { ...options, signal: controller.signal })
        .finally(() => clearTimeout(id));
    }

    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    // Warm-up parallelo: healthz + booking ping
    async function warmUpServerParallel(bookingId, i18n){
      const msg = document.getElementById("msg");
      if (msg && i18n && i18n.waking) {
        msg.textContent = i18n.waking + " (potrebbe richiedere fino a 60s)";
      }

      let delay = 700;
      const t0 = Date.now();
      while (Date.now() - t0 < 65000) {
        try {
          const healthz = fetchWithTimeout(`${API_BASE}/healthz?ts=${Date.now()}`, {
            cache: "no-store", timeout: 7000
          });
          const bookingPing = fetchWithTimeout(
            `${API_BASE}/booking/${encodeURIComponent(bookingId)}?ping=1&t=${Date.now()}`,
            { cache: "no-store", mode: "cors", timeout: 12000 }
          );
          const res = await Promise.any([healthz, bookingPing]);
          if (res && res.ok) return true;
        } catch (_) {}
        await sleep(delay);
        delay = Math.min(delay * 1.6, 3500);
      }
      return false;
    }

    function fmtISO(iso){
      const [y,m,d] = iso.split("-"); return `${d}/${m}/${y}`;
    }

    // Auto-close dopo 15s dalla risposta
    function scheduleAutoClose() {
      setTimeout(() => {
        try {
          if (window.opener && !window.opener.closed) { window.close(); return; }
          window.open('', '_self'); window.close();
        } catch(e){}
        if (document.referrer) { location.href = document.referrer; return; }
        if (history.length > 1) { history.back(); return; }
        document.getElementById("hint").textContent = "Puoi chiudere questa scheda e tornare alla guida.";
      }, 15000);
    }

    async function init(){
      const lang = detectLang();
      const T = M[lang];
      document.documentElement.lang = lang;

      const msg = document.getElementById("msg");
      const sub = document.getElementById("sub");
      const hint = document.getElementById("hint");
      const note = document.getElementById("note");

      const bookingIdRaw = new URL(location.href).searchParams.get("b");
      const bookingId = bookingIdRaw ? bookingIdRaw.replace(/\D/g,"") : "";
      if (!bookingId) {
        msg.textContent = T.missing;
        sub.textContent = T.hintMissing;
        msg.className = "err";
        return;
      }

      const awake = await warmUpServerParallel(bookingId, T);
      if (!awake) {
        msg.className = "err";
        msg.textContent = T.netErr;
        sub.textContent = T.netExplain;
        hint.textContent = T.retryHint;
        return;
      }

      msg.textContent = T.loading; sub.textContent = ""; hint.textContent = ""; note.textContent = "";

      try {
        const url = `${API_BASE}/booking/${encodeURIComponent(bookingId)}?t=${Date.now()}`;
        const r = await fetchWithTimeout(url, { cache:"no-store", mode:"cors", timeout:18000 });

        if (!r.ok) throw new Error(`Backend non ok: ${await r.text().catch(()=>`HTTP ${r.status}`)}`);
        const j = await r.json();
        if (!j.ok || !j.start || !j.end) throw new Error(j.error || "Risposta non valida");

        const startISO = j.start.split("T")[0];
        const endISO   = j.end.split("T")[0];
        const today    = new Date(); today.setHours(0,0,0,0);

        const start = new Date(...startISO.split("-").map((n,i)=>i==1?Number(n)-1:Number(n)));
        const end   = new Date(...endISO.split("-").map((n,i)=>i==1?Number(n)-1:Number(n)));
        const inWindow = today >= start && today <= end;

        if (inWindow) {
          msg.className = "ok";
          msg.textContent = T.okTitle;
          sub.textContent = T.okSub;
          note.textContent = T.pleaseVideo;
          hint.textContent = T.okHintSending;

          try {
            const openUrl = `${API_BASE}/open/${encodeURIComponent(bookingId)}?t=${Date.now()}`;
            const or = await fetchWithTimeout(openUrl, { cache:"no-store", mode:"cors", timeout:18000 });
            const ot = await or.json().catch(()=> ({}));
            hint.textContent = (or.ok && ot && ot.ok) ? T.okHintSent : T.okHintFail;
          } catch (e) { hint.textContent = T.okHintFail; }

          scheduleAutoClose();

        } else {
          msg.textContent = T.outside(fmtISO(startISO), fmtISO(endISO));
          sub.textContent = T.needHelp;
          note.textContent = T.pleaseVideo;
          scheduleAutoClose();
        }

      } catch (err) {
        msg.className = "err"; msg.textContent = T.netErr;
        sub.textContent = (String(err).includes("fetch") ? T.netExplain : String(err.message||err));
        hint.textContent = T.retryHint;
      }
    }
    init();
  </script>
</body>
</html>
