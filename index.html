<script>
const API_BASE = "https://<tuo-servizio>.onrender.com"; // ← URL Render

async function openDoor() {
  const bookingId = new URL(location.href).searchParams.get('b')?.replace(/\D/g,'');
  if (!bookingId) { alert('❌ Booking ID mancante (?b=...)'); return; }

  // 1) prendo le date dal backend
  const r = await fetch(`${API_BASE}/checkBooking?b=${bookingId}`);
  const j = await r.json();
  if (!j.ok) { alert('Errore checkBooking: ' + (j.error || '')); return; }

  const [ay,am,ad] = j.arrival.split('-').map(Number);
  const [dy,dm,dd] = j.departure.split('-').map(Number);
  const arrival = new Date(ay,am-1,ad);
  const departure = new Date(dy,dm-1,dd);
  const same = d => (d.setHours(0,0,0,0), d);
  const allowed = same(new Date()) >= same(new Date(arrival)) && same(new Date()) <= same(new Date(departure));

  if (allowed) {
    // invio lato server (token Telegram nascosto)
    const win = window.open(`${API_BASE}/notify?text=${encodeURIComponent('🌞 La tua avventura a NeaSpace inizia ora: la porta è aperta. Sali al secondo piano, porta destra, keybox 0204. Scrivici quando arrivi!')}`, "_blank");
    setTimeout(()=>{ try{ if(win) win.close(); }catch(_){} }, 1000);
  } else {
    const fmt = d => d.toLocaleDateString('it-IT',{day:'2-digit',month:'2-digit',year:'numeric'});
    alert(`🚪 La porta si apre solo tra ${fmt(arrival)} e ${fmt(departure)}.`);
  }
}
</script>
