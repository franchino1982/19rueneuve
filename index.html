<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Apri Porta - NEASPACE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Anti-cache per GitHub Pages -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <style>
    :root{--bg:#EAF6FF;--fg:#111}
    body{margin:0;background:var(--bg);color:var(--fg);font:600 28px/1.6 system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;text-align:center}
    .wrap{padding:60px 16px}
    .sub{font-size:16px;font-weight:500;opacity:.7;margin-top:6px}
    .err{color:#b00020;font-weight:700}
    .ok{color:#0a6800;font-weight:700}
    .muted{font-size:16px;opacity:.8;margin-top:14px}
  </style>
</head>
<body>
  <div class="wrap">
    <div id="msg">‚è≥ Controllo prenotazione.</div>
    <div id="sub" class="sub"></div>
    <div id="hint" class="muted"></div>
  </div>

  <script>
    const API_BASE = "https://one9rueneuve.onrender.com";

    // Util: timeout su fetch
    function fetchWithTimeout(resource, options = {}) {
      const { timeout = 12000 } = options; // 12s
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeout);
      return fetch(resource, { ...options, signal: controller.signal })
        .finally(() => clearTimeout(id));
    }

    // Date ISO -> "DD/MM/YYYY" (stabile su tutti i browser)
    function fmtISO(iso){
      const [y,m,d] = iso.split("-"); return `${d}/${m}/${y}`;
    }

    async function init(){
      const msg = document.getElementById("msg");
      const sub = document.getElementById("sub");
      const hint = document.getElementById("hint");

      const bookingIdRaw = new URL(location.href).searchParams.get("b");
      const bookingId = bookingIdRaw ? bookingIdRaw.replace(/\D/g,"") : "";
      if (!bookingId) {
        msg.textContent = "‚ùå Booking ID mancante.";
        sub.textContent = "Aggiungi ?b=NUMERO all‚ÄôURL.";
        msg.className = "err";
        return;
      }

      msg.textContent = "‚è≥ Controllo prenotazione‚Ä¶";
      sub.textContent = "";
      hint.textContent = "";

      try {
        // bust cache del backend
        const url = `${API_BASE}/booking/${encodeURIComponent(bookingId)}?t=${Date.now()}`;
        console.log("‚Üí GET", url);
        const r = await fetchWithTimeout(url, { cache: "no-store", mode: "cors", timeout: 12000 });

        // Se il server non manda CORS, qui va in catch con DOMException: abort/TypeError
        if (!r.ok) {
          const txt = await r.text().catch(()=>`HTTP ${r.status}`);
          throw new Error(`Backend non ok: ${txt}`);
        }

        const j = await r.json();
        console.log("‚Üê booking response:", j);

        if (!j.ok || !j.start || !j.end) {
          throw new Error(j.error || "Risposta non valida dal backend");
        }

        // Confronto date in modo robusto
        const startISO = j.start.split("T")[0];   // YYYY-MM-DD
        const endISO   = j.end.split("T")[0];     // YYYY-MM-DD
        const today    = new Date(); today.setHours(0,0,0,0);

        const [sy, sm, sd] = startISO.split("-").map(Number);
        const [ey, em, ed] = endISO.split("-").map(Number);
        const start = new Date(sy, sm-1, sd);
        const end   = new Date(ey, em-1, ed);

        const inWindow = today >= start && today <= end;

        if (inWindow) {
          msg.className = "ok";
          msg.textContent = "üåû La tua avventura a NeaSpace inizia ora: la porta √® aperta.";
          sub.textContent = "Sali al secondo piano (porta destra). Keybox codice 0204.";
          hint.textContent = "Invio conferma in corso‚Ä¶";

          // Chiamo l'apertura (con cache-bust) e mostro eventuali errori
          try {
            const openUrl = `${API_BASE}/open/${encodeURIComponent(bookingId)}?t=${Date.now()}`;
            console.log("‚Üí OPEN", openUrl);
            const or = await fetchWithTimeout(openUrl, { cache: "no-store", mode: "cors", timeout: 12000 });
            const ot = await or.json().catch(()=> ({}));
            console.log("‚Üê open response:", or.status, ot);
            if (!(or.ok && ot && ot.ok)) {
              hint.textContent = "‚ö†Ô∏è Telegram non confermato (ma la porta √® aperta).";
            } else {
              hint.textContent = "‚úÖ Conferma inviata.";
            }
          } catch (e) {
            console.warn(e);
            hint.textContent = "‚ö†Ô∏è Non riesco a inviare la conferma su Telegram.";
          }

        } else {
          msg.className = "";
          msg.textContent = `üö™ La porta si apre solo tra ${fmtISO(startISO)} e ${fmtISO(endISO)}.`;
          sub.textContent = "Se hai bisogno di assistenza contattaci pure.";
        }

      } catch (err) {
        console.error(err);
        msg.className = "err";
        msg.textContent = "‚ö†Ô∏è Errore durante il controllo prenotazione.";
        // Messaggio utile per i casi pi√π comuni
        if (String(err).includes("Failed to fetch") || String(err).includes("NetworkError") || String(err).includes("AbortError")) {
          sub.textContent = "Il server non ha risposto o il browser ha bloccato la richiesta (CORS/timeout).";
          hint.textContent = "Prova a ricaricare con Ctrl/Cmd-Shift-R. Se persiste, verifica CORS su Render.";
        } else {
          sub.textContent = String(err.message || err);
        }
      }
    }

    init();
  </script>
</body>
</html>
