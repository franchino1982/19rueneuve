<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Apri Porta - NEASPACE</title>
  <script>
    async function init() {
      const API_BASE = "https://one9rueneuve.onrender.com";
      const bookingId = new URLSearchParams(window.location.search).get('b');
      const msgBox = document.getElementById("message");

      if (!bookingId) {
        msgBox.innerHTML = "<h2>‚ùå Booking ID mancante</h2>";
        return;
      }

      msgBox.innerHTML = "<h2>‚è≥ Controllo prenotazione...</h2>";

      try {
        // 1) Prendo date dal backend
        const res = await fetch(${API_BASE}/booking/${encodeURIComponent(bookingId)}, { cache: "no-store" });
        if (!res.ok) throw new Error("Server non disponibile");
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "Errore dati");

        const start = new Date(data.start);
        const end   = new Date(data.end);
        const today = new Date();
        start.setHours(0,0,0,0);
        end.setHours(0,0,0,0);
        today.setHours(0,0,0,0);

        if (today >= start && today <= end) {
          // 2) Dentro le date ‚Üí invio apertura via backend (nessun popup)
          msgBox.innerHTML = <h2>üåû La porta √® aperta! Sali al secondo piano, porta destra, codice 0204.<br>Mandaci un messaggino per confermare che siete a casa!</h2>;

          try {
            const resp = await fetch(${API_BASE}/open/${encodeURIComponent(bookingId)}, { method: "GET", cache: "no-store" });
            const tg = await resp.json().catch(() => ({}));
            if (!(resp.ok && tg && tg.ok)) {
              const reason = (tg && (tg.description || tg.error)) || HTTP ${resp.status};
              console.error("Telegram non inviato:", reason);
            }
          } catch (e) {
            console.error("Errore invio Telegram:", e);
          }
        } else {
          // 3) Fuori dalle date ‚Üí messaggio con intervallo
          const fmt = d => d.toLocaleDateString('it-IT', { day:'2-digit', month:'2-digit', year:'numeric' });
          msgBox.innerHTML = <h2>üö´ La porta si apre solo tra ${fmt(start)} e ${fmt(end)}.</h2>;
        }
      } catch (err) {
        console.error(err);
        msgBox.innerHTML = "<h2>‚ö† Errore: Failed to fetch</h2>";
      }
    }

    window.onload = init;
  </script>
  <style>
    body {
      background-color:#EAF6FF; color:#1a1a1a;
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin:0; padding:0; text-align:center; font-size:28px;
    }
    .header {
      background:white; padding:20px 10px;
      display:flex; align-items:center; justify-content:center;
    }
    .header img { max-height:80px; margin-right:20px; }
    .header span { font-size:48px; font-weight:bold; color:#111; }
    .content { padding:80px 25px; }
    h2 { font-size:42px; margin:30px; line-height:1.6; }
  </style>
</head>
<body>
  <div class="header">
    <img src="https://login.smoobu.com/upload/images/website/logo/6/4/6/6/e/2/a/6/website_logo_530938_abf503416885c3141843d801c3717c2063e4bda6b56bf5268b3e1b264a7d8eae.jpg" alt="Logo NeaSpace">
    <span>NeaSpace</span>
  </div>
  <div class="content" id="message">
    <h2>‚è≥ Controllo prenotazione in corso...</h2>
  </div>
</body>
</html>
